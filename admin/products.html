<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Produkte - FairwayService Admin</title>
  <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
  <header class="admin-header">
    <div class="container header-content">
      <a href="dashboard.html" class="logo">Fairway<span class="logo-green">Service</span></a>
      <div class="user-info">
        <span class="user-name" id="userEmail"></span>
        <button class="btn-logout" id="logoutBtn">Abmelden</button>
      </div>
    </div>
  </header>

  <div class="container">
    <nav class="nav-tabs">
      <button class="nav-tab" onclick="location.href='dashboard.html'">Dashboard</button>
      <button class="nav-tab" onclick="location.href='orders.html'">Bestellungen</button>
      <button class="nav-tab active" onclick="location.href='products.html'">Produkte</button>
      <button class="nav-tab" onclick="location.href='issues.html'">Meldungen</button>
      <button class="nav-tab" onclick="location.href='settings.html'">Einstellungen</button>
    </nav>
  </div>

  <main class="container">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Produkte verwalten</h3>
        <button class="btn btn-primary btn-sm" id="addProductBtn">+ Produkt hinzuf√ºgen</button>
      </div>

      <div style="margin-bottom: 20px; display: flex; gap: 12px;">
        <button class="btn btn-secondary btn-sm" id="showGastro">üçî Gastro</button>
        <button class="btn btn-secondary btn-sm" id="showShop">üõí Shop</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Kategorie</th>
              <th>Preis</th>
              <th>Verf√ºgbar</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--gray-500);">Lade Produkte...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <div id="productModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Produkt hinzuf√ºgen</h3>
      </div>
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="form-group">
          <label class="form-label">Typ</label>
          <select id="productType" class="form-select" required>
            <option value="gastro">Gastro</option>
            <option value="shop">Shop</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Name</label>
          <input type="text" id="productName" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Kategorie</label>
          <input type="text" id="productCategory" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Preis (‚Ç¨)</label>
          <input type="number" id="productPrice" class="form-input" step="0.01" required>
        </div>
        <div class="form-group">
          <label class="form-checkbox">
            <input type="checkbox" id="productAvailable" checked>
            <span>Verf√ºgbar</span>
          </label>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, collection, query, onSnapshot, doc, setDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const app = initializeApp({
      apiKey: "AIzaSyBHa8MBAJszkm22e7CihRGCHRr_k-P4y7w",
      authDomain: "fairwayservice-golf.firebaseapp.com",
      projectId: "fairwayservice-golf",
      storageBucket: "fairwayservice-golf.firebasestorage.app",
      messagingSenderId: "297814448831",
      appId: "1:297814448831:web:b8c2f5c42bb86f7f95ac81"
    });

    const auth = getAuth(app);
    const db = getFirestore(app);
    const clubId = localStorage.getItem('adminClubId');

    let currentType = 'gastro';
    let allProducts = [];

    onAuthStateChanged(auth, (user) => {
      if (!user || !clubId) window.location.href = 'index.html';
      else {
        document.getElementById('userEmail').textContent = user.email;
        loadProducts();
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await signOut(auth);
      localStorage.clear();
      window.location.href = 'index.html';
    });

    document.getElementById('showGastro').addEventListener('click', () => { currentType = 'gastro'; renderProducts(); });
    document.getElementById('showShop').addEventListener('click', () => { currentType = 'shop'; renderProducts(); });

    document.getElementById('addProductBtn').addEventListener('click', () => {
      document.getElementById('productForm').reset();
      document.getElementById('productId').value = '';
      document.getElementById('modalTitle').textContent = 'Produkt hinzuf√ºgen';
      document.getElementById('productModal').classList.add('active');
    });

    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const productData = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        price: parseFloat(document.getElementById('productPrice').value),
        available: document.getElementById('productAvailable').checked,
        type: document.getElementById('productType').value
      };

      const productId = document.getElementById('productId').value;

      try {
        if (productId) {
          await updateDoc(doc(db, `clubs/${clubId}/products`, productId), productData);
        } else {
          await setDoc(doc(db, `clubs/${clubId}/products`, Date.now().toString()), productData);
        }
        closeModal();
      } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim Speichern');
      }
    });

    function loadProducts() {
      onSnapshot(query(collection(db, `clubs/${clubId}/products`)), (snapshot) => {
        allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderProducts();
      });
    }

    function renderProducts() {
      const filtered = allProducts.filter(p => p.type === currentType);
      const tbody = document.getElementById('productsBody');

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--gray-500);">Keine Produkte</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(product => `
        <tr>
          <td>${product.name}</td>
          <td>${product.category}</td>
          <td>‚Ç¨${product.price.toFixed(2)}</td>
          <td>${product.available ? '<span class="badge badge-success">Ja</span>' : '<span class="badge badge-danger">Nein</span>'}</td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="editProduct('${product.id}')">Bearbeiten</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product.id}')">L√∂schen</button>
          </td>
        </tr>
      `).join('');
    }

    window.editProduct = function(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;

      document.getElementById('productId').value = productId;
      document.getElementById('productType').value = product.type;
      document.getElementById('productName').value = product.name;
      document.getElementById('productCategory').value = product.category;
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productAvailable').checked = product.available;
      document.getElementById('modalTitle').textContent = 'Produkt bearbeiten';
      document.getElementById('productModal').classList.add('active');
    };

    window.deleteProduct = async function(productId) {
      if (!confirm('Produkt wirklich l√∂schen?')) return;
      try {
        await deleteDoc(doc(db, `clubs/${clubId}/products`, productId));
      } catch (error) {
        console.error('Error:', error);
        alert('Fehler beim L√∂schen');
      }
    };

    window.closeModal = function() {
      document.getElementById('productModal').classList.remove('active');
    };
  </script>
</body>
</html>
